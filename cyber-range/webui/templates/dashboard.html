{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h6 class="text-muted text-uppercase mb-1">Mission Control</h6>
        <h2 class="font-tech text-white mb-0">{{ instance_name }}</h2>
        <small class="text-muted font-mono">UUID: {{ instance_id }}</small>
    </div>
        <p class="text-muted small text-monospace mb-0">
            <i class="fa-solid fa-server me-1"></i> OpenStack RegionOne
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="/" class="btn btn-outline-light font-mono">
            <i class="fa-solid fa-arrow-left me-1"></i> LOBBY
        </a>
        <button onclick="destroyInstance('{{ instance_id }}')" class="btn btn-danger font-tech tracking-wide">
            <i class="fa-solid fa-bomb me-2"></i>DESTROY
        </button>
    </div>
</div>

<div class="row g-4 h-100">
    
    <div class="col-lg-4 d-flex flex-column gap-3">
        
        <div class="card border-info shadow-lg bg-dark-glass">
            <div class="card-header bg-transparent border-info d-flex justify-content-between align-items-center">
                <span class="text-info fw-bold font-tech"><i class="fa-solid fa-shield-halved me-2"></i>BLUE TEAM</span>
                <span class="badge bg-info text-dark">DEFENDER</span>
            </div>
            <div class="card-body">
                
                {% if status.soc_dashboard_url %}
                <a href="{{ status.soc_dashboard_url }}" target="_blank" class="btn btn-info w-100 mb-3 fw-bold font-tech">
                    <i class="fa-solid fa-chart-line me-2"></i> OPEN WAZUH
                </a>
                {% else %}
                <button disabled class="btn btn-secondary w-100 mb-3">PROVISIONING...</button>
                {% endif %}
                
                <div class="small font-mono text-muted mb-2">CREDENTIALS</div>
                <div class="bg-dark rounded p-2 border border-secondary mb-3">
                    <div class="d-flex justify-content-between">
                        <span>User:</span> <span class="text-info">{{ status.soc_credentials.username }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Pass:</span> <span class="text-info">{{ status.soc_credentials.password }}</span>
                    </div>
                </div>

                <label class="text-muted small text-monospace mb-1">SSH SOC COMMAND</label>
                <div class="input-group input-group-sm mb-3">
                    <span class="input-group-text bg-dark border-secondary"><i class="fa-solid fa-terminal text-info"></i></span>
                    <input type="text" class="form-control font-mono bg-dark text-light border-secondary" value="{{ status.log_vm_ssh_command }}" readonly id="ssh-soc">
                    <button class="btn btn-dark border-secondary" onclick="copyToClipboard('ssh-soc')"><i class="fa-regular fa-copy"></i></button>
                </div>

                <hr class="border-secondary my-3 opacity-50">

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small font-mono text-muted text-uppercase fw-bold">
                        <i class="fa-solid fa-server me-1"></i> Target System
                    </span>
                    <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">VICTIM</span>
                </div>
                
                <div class="row small">
                    <div class="col-6">
                        <small class="text-muted d-block" style="font-size:0.7rem">PUBLIC IP</small>
                        <span class="fs-6 fw-bold text-white">{{ status.victim_vm_floating_ip or '...' }}</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block" style="font-size:0.7rem">PRIVATE IP</small>
                        <span class="font-mono text-info">{{ status.victim_vm_private_ip or '...' }}</span>
                    </div>
                </div>

            </div>
        </div>

        <div class="card border-danger shadow-lg bg-dark-glass">
            <div class="card-header bg-transparent border-danger d-flex justify-content-between align-items-center">
                <span class="text-danger fw-bold font-tech"><i class="fa-solid fa-user-ninja me-2"></i>RED TEAM</span>
                <span class="badge bg-danger">ATTACKER</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted d-block" style="font-size:0.7rem">PUBLIC IP</small>
                        <span class="fs-5 fw-bold text-white">{{ status.attack_vm_floating_ip or '...' }}</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block" style="font-size:0.7rem">PRIVATE IP</small>
                        <span class="font-mono text-danger">{{ status.attack_vm_private_ip or '...' }}</span>
                    </div>
                </div>
                
                <label class="text-muted small text-monospace mb-1">SSH ATTACK COMMAND</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text bg-dark border-secondary"><i class="fa-solid fa-terminal text-danger"></i></span>
                    <input type="text" class="form-control font-mono bg-dark text-light border-secondary" value="{{ status.attack_vm_ssh_command }}" readonly id="ssh-attack">
                    <button class="btn btn-dark border-secondary" onclick="copyToClipboard('ssh-attack')"><i class="fa-regular fa-copy"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card h-100 shadow-lg border-0">
            <div class="card-header bg-white border-bottom py-2 d-flex justify-content-between align-items-center">
                <span class="font-tech text-dark fw-bold" style="letter-spacing: 1px;">
                    <i class="fa-solid fa-sitemap me-2 text-primary"></i>INFRASTRUCTURE MAP
                </span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="cy.fit()"><i class="fa-solid fa-compress"></i> Fit</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>
            </div>
            
            <div class="card-body p-0 position-relative" style="background-color: #fafafa;">
                <div style="position: absolute; width: 100%; height: 100%; background-image: linear-gradient(#e0e0e0 1px, transparent 1px), linear-gradient(90deg, #e0e0e0 1px, transparent 1px); background-size: 20px 20px;"></div>
                
                <div id="cy" style="width: 100%; height: 600px; display: block;"></div>
            </div>
        </div>
    </div>
</div>

<script id="lab-data-source" type="application/json">
    {{ status | tojson | safe }}
</script>

<script>
    // === GLOBAL STATE ===
    document.body.setAttribute('data-instance-id', '{{ instance_id }}');
    
    var LAB_DATA = {};
    var cy = null;
    var pollDelay = 3000;  // Start at 3 seconds
    var maxPollDelay = 15000;  // Cap at 15 seconds
    var pollTimeout = null;

    // === PARSE INITIAL DATA ===
    try {
        var rawData = document.getElementById('lab-data-source').textContent;
        LAB_DATA = JSON.parse(rawData);
        console.log("Initial LAB_DATA loaded:", LAB_DATA);
    } catch (e) { 
        console.error("Parsing Error", e); 
    }

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
        const instanceId = document.body.getAttribute('data-instance-id');
        
        if (!instanceId) {
            console.error("No instance ID found!");
            return;
        }

        // Render initial topology if data exists
        if (LAB_DATA && Object.keys(LAB_DATA).length > 0) {
            renderTopology(LAB_DATA);
        }

        // Start polling for updates
        startPolling(instanceId);
    });

    // === POLLING LOGIC ===
    function startPolling(instanceId) {
        console.log("Starting polling for instance:", instanceId);
        
        const poll = () => {
            fetch(`/api/poll/${instanceId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Poll response:", data);
                    
                    // Update UI status indicators
                    updateStatusUI(data);

                    // Update LAB_DATA if outputs changed
                    if (data.outputs && JSON.stringify(data.outputs) !== JSON.stringify(LAB_DATA)) {
                        console.log("Outputs changed, updating LAB_DATA");
                        LAB_DATA = data.outputs;
                        
                        // Re-render topology with new IPs
                        if (cy) {
                            renderTopology(LAB_DATA);
                        }
                    }

                    // Adaptive polling delay
                    if (data.status === 'deploying' || data.status === 'destroying' || data.status === 'pending') {
                        // Slow down polling during long operations
                        pollDelay = Math.min(pollDelay * 1.15, maxPollDelay);
                    } else if (data.status === 'active') {
                        // Fast polling when active (user might be testing)
                        pollDelay = 5000;
                    } else {
                        // Reset to normal for other states
                        pollDelay = 3000;
                    }
                    
                    console.log(`Next poll in ${pollDelay}ms`);
                    
                    // Schedule next poll
                    pollTimeout = setTimeout(poll, pollDelay);
                })
                .catch(err => {
                    console.error("Poll error:", err);
                    
                    // Slow down on errors
                    pollDelay = Math.min(pollDelay * 1.5, 30000);
                    
                    // Retry
                    pollTimeout = setTimeout(poll, pollDelay);
                });
        };
        
        // Start polling immediately
        poll();
    }

    // === UPDATE STATUS BADGES ===
    function updateStatusUI(data) {
        const badge = document.getElementById('nav-status-badge');
        const text = document.getElementById('status-text');
        const spinner = document.getElementById('status-spinner');

        if (!badge || !text || !spinner) {
            console.warn("Status UI elements not found");
            return;
        }

        switch(data.status) {
            case 'active':
                badge.className = "badge rounded-pill bg-success border border-success shadow-sm";
                text.innerText = "ONLINE";
                spinner.classList.add('d-none');
                break;
                
            case 'deploying':
            case 'pending':
                badge.className = "badge rounded-pill bg-warning text-dark border border-warning shadow-sm";
                text.innerText = data.status.toUpperCase();
                spinner.classList.remove('d-none');
                break;
                
            case 'destroying':
                badge.className = "badge rounded-pill bg-danger border border-danger shadow-sm";
                text.innerText = "DESTROYING";
                spinner.classList.remove('d-none');
                break;
                
            case 'failed':
                badge.className = "badge rounded-pill bg-danger border border-danger shadow-sm";
                text.innerText = "FAILED";
                spinner.classList.add('d-none');
                
                // Show error message if available
                if (data.error) {
                    console.error("Deployment error:", data.error);
                }
                break;
                
            default:
                badge.className = "badge rounded-pill bg-secondary border border-secondary shadow-sm";
                text.innerText = data.status ? data.status.toUpperCase() : "UNKNOWN";
                spinner.classList.add('d-none');
        }
    }

    // === RENDER TOPOLOGY GRAPH ===
    function renderTopology(data) {
        if (!document.getElementById('cy')) {
            console.warn("Cytoscape container not found");
            return;
        }
        
        console.log("Rendering topology with data:", data);

        var elements = [];

        // --- 1. INFRASTRUCTURE NODES ---
        elements.push({ 
            data: { id: 'public', label: 'Internet', type: 'world' } 
        });
        elements.push({ 
            data: { id: 'router', label: 'Router GW', type: 'router' } 
        });
        elements.push({ 
            data: { id: 'net_main', label: 'Network CyberGuard\n(192.168.0.0/24)', type: 'cloud_blue' } 
        });
        elements.push({ 
            data: { id: 'net_attack', label: 'Network Attack\n(192.168.50.0/24)', type: 'cloud_red' } 
        });

        // Router connections
        elements.push({ data: { source: 'public', target: 'router' } });
        elements.push({ data: { source: 'router', target: 'net_main' } });
        elements.push({ data: { source: 'router', target: 'net_attack' } });

        // --- 2. VIRTUAL MACHINES ---
        
        // Extract IPs (handle both nested .value and direct values)
        var kaliIp = data.attack_vm_private_ip?.value || data.attack_vm_private_ip || 'Provisioning...';
        var socIp = data.log_vm_private_ip?.value || data.log_vm_private_ip || 'Provisioning...';
        var victimIp = data.victim_vm_private_ip?.value || data.victim_vm_private_ip || 'Provisioning...';

        // Kali (Attacker)
        elements.push({ 
            data: { id: 'vm_kali', label: 'Kali Linux\n' + kaliIp, type: 'pc_attacker' } 
        });
        elements.push({ data: { source: 'net_attack', target: 'vm_kali' } });

        // SOC (Defender)
        elements.push({ 
            data: { id: 'vm_soc', label: 'SOC / Wazuh\n' + socIp, type: 'pc_defender' } 
        });
        elements.push({ data: { source: 'net_main', target: 'vm_soc' } });

        // Victim
        elements.push({ 
            data: { id: 'vm_victim', label: 'Mr. Robot\n' + victimIp, type: 'pc_defender' } 
        });
        elements.push({ data: { source: 'net_main', target: 'vm_victim' } });

        // --- 3. INITIALIZE OR UPDATE CYTOSCAPE ---
        if (cy) {
            // Update existing graph
            cy.elements().remove();
            cy.add(elements);
            cy.layout({ name: 'cose' }).run();
        } else {
            // Create new graph
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                
                layout: {
                    name: 'cose',
                    idealEdgeLength: 80,
                    nodeOverlap: 20,
                    refresh: 20,
                    fit: true,
                    padding: 50,
                    randomize: false,
                    componentSpacing: 100,
                    nodeRepulsion: 400000,
                    edgeElasticity: 100,
                    nestingFactor: 5,
                },

                style: [
                    // GENERAL STYLES
                    {
                        selector: 'node',
                        style: {
                            'font-family': '"Font Awesome 6 Free", "Font Awesome 6 Brands", sans-serif',
                            'font-weight': '900',
                            'label': 'data(label)',
                            'text-valign': 'bottom',
                            'text-halign': 'center',
                            'text-margin-y': 6,
                            'font-size': '11px',
                            'color': '#333', 
                            'text-wrap': 'wrap',
                            'background-color': '#fff',
                            'border-width': 0
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#adb5bd',
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'none'
                        }
                    },
                    // WORLD
                    {
                        selector: 'node[type="world"]',
                        style: {
                            'content': '\uf0ac',
                            'font-size': '30px',
                            'color': '#6c757d',
                            'text-valign': 'center'
                        }
                    },
                    // ROUTER
                    {
                        selector: 'node[type="router"]',
                        style: {
                            'content': '\uf233',
                            'shape': 'round-rectangle',
                            'background-color': '#fff',
                            'border-width': 2,
                            'border-color': '#343a40',
                            'width': '40px',
                            'height': '40px',
                            'text-valign': 'center',
                            'color': '#343a40',
                            'font-size': '20px'
                        }
                    },
                    // BLUE CLOUD
                    {
                        selector: 'node[type="cloud_blue"]',
                        style: {
                            'content': '\uf0c2',
                            'font-size': '60px',
                            'color': '#3498db',
                            'z-index': 1,
                            'text-valign': 'center'
                        }
                    },
                    // RED CLOUD
                    {
                        selector: 'node[type="cloud_red"]',
                        style: {
                            'content': '\uf0c2',
                            'font-size': '60px',
                            'color': '#e74c3c',
                            'z-index': 1,
                            'text-valign': 'center'
                        }
                    },
                    // ATTACKER PC
                    {
                        selector: 'node[type="pc_attacker"]',
                        style: {
                            'content': '\uf108',
                            'shape': 'rectangle',
                            'background-color': '#fff',
                            'border-width': 2,
                            'border-color': '#dc3545',
                            'color': '#dc3545',
                            'width': '35px',
                            'height': '35px',
                            'font-size': '18px',
                            'text-valign': 'center'
                        }
                    },
                    // DEFENDER PC
                    {
                        selector: 'node[type="pc_defender"]',
                        style: {
                            'content': '\uf108',
                            'shape': 'rectangle',
                            'background-color': '#fff',
                            'border-width': 2,
                            'border-color': '#0dcaf0',
                            'color': '#0dcaf0',
                            'width': '35px',
                            'height': '35px',
                            'font-size': '18px',
                            'text-valign': 'center'
                        }
                    }
                ]
            });

            cy.resize();
            cy.fit();
        }
    }

    // === UTILITY FUNCTIONS ===
    function copyToClipboard(elementId) {
        var el = document.getElementById(elementId);
        if (el) { 
            el.select(); 
            navigator.clipboard.writeText(el.value)
                .then(() => console.log('Copied:', el.value))
                .catch(err => console.error('Copy failed:', err));
        }
    }

    function destroyInstance(id) {
        if (!confirm("Destroy lab? This action is irreversible.")) {
            return;
        }
        
        // Stop polling
        if (pollTimeout) {
            clearTimeout(pollTimeout);
        }
        
        fetch(`/api/destroy/${id}`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    alert("Destroy started. Redirecting to lobby...");
                    window.location.href = "/";
                } else {
                    throw new Error('Destroy request failed');
                }
            })
            .catch(err => {
                console.error('Destroy error:', err);
                alert("Error: " + err.message);
            });
    }

    // === CLEANUP ON PAGE UNLOAD ===
    window.addEventListener('beforeunload', function() {
        if (pollTimeout) {
            clearTimeout(pollTimeout);
        }
    });
</script>

{% endblock %}